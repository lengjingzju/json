# 一种有限定义域内快速整除的实现方法

## 实现原理

一般CPU整数除法的速度远远慢于整数乘法，那么是否可以将除法形式 `N/D` 换成乘法形式 `((type)N * M) >> K` 呢？假设可行，有如下两种情况：

* D 是 2 的整数次方

    ```sh
    pow(2,K) = D

    K = log2(D)
    M = 1
    ```

    即 `N/D` 可以写成 `N >> log2(D)` 的形式

* D 不是 2 的整数次方

    ```sh
    N/D = (N / pow(2,K)) * (pow(2,K) / D)
        = (N * (pow(2,K) / D)) / pow(2,K)
    ```

    `pow(2,K) / D` 不一定可以整除，我们需要加上一个 delta 值使之整除，delta 值一定小于 D，且大于等于 0。

    反证：如果 delta 小于 0，当 N 刚好被 D 整除时，此时会减去 delta 带来的附加值，整除值就比真正的值小 1，所以 delta 不能小于 0。

    ```sh
    N/D = (N / pow(2,K)) * ((pow(2,K) + delta) / D)
        = (N / D) * ((pow(2,K) + delta) / pow(2,K))

    N/D = (N * M) >> K    ( M = (pow(2,K) + delta) / D )
    N/D = (N / D) + ((N * delta) / (D * pow(2,K)))
    ```

    `N / D` 的小数部分最大为 `(D - 1) / D`，要保证上述式子成立，则小数部分小于 1。

    ```sh
    ((D - 1) / D) + ((N * delta) / (D * pow(2,K))) < 1
    ((N * delta) / (D * pow(2,K))) < (1 / D)
    (N * delta) / pow(2,K) < 1
    log2(N) + log2(delta) - K < 0
    K > log2(N) + log2(delta)
    ```

    综上，我们可以得到如下限制条件：

    * `K > log2(N)`
    * `K <= log2(N) + log2(D - 1) + 1`  : delta 的最大值为 `D - 1`
    * `delta = D - (pow(2,K) % D)`
    * `M = (pow(2,K) + delta) / D`
    * `N * M < pow(2,bits)`             : bits 为计算机最大能表示的整数(64或128)

    已知 N 的范围和 D 的值，则 K 的范围就可以算出，从一个确定的 K 和 D 就可以得到 M。
    符合上述限制条件时 `N/D` 换成乘法形式 `((type)N * M) >> K` 。

* D 存在 2 的 S 次方的公因子

    上面限制条件的 `N * M` 可能超出计算机最大能表示的整数，如果 D 存在 2 的 S 次方的公因子，`N * M` 就可以缩小。
    即 `((type)N * M) >> K` 可写成 `((type)(N >> S) * M) >> K` 的形式，则限制条件变为：

    ```sh
    NS = N >> S
    DS = D >> S
    K > log2(NS)
    K <= log2(NS) + log2(DS - 1) + 1
    delta = DS - (pow(2,K) % DS)
    M = (pow(2,K) + delta) / DS
    NS * M < pow(2,bits)
    ```

    如果 `((type)(N >> S) * M)` 还是超出计算机最大能表示的整数，此时只能分解 N 和 M 再相乘了。


## python 实现

```python
import math, sys

max16 = 1<<16
max32 = 1<<32
max64 = 1<<64
max128 = 1<<128
en128 = False

def fast_div(D, maxN, S):
    DS = D >> S
    maxNS = maxN >> S

    logn = math.log(maxNS, 2)
    mink = int(logn) + 1
    maxk = int(logn + math.log(DS - 1, 2)) + 1

    for K in range(mink, maxk + 1):
        delta = DS - (1<<K) % DS
        if delta:
            deltak = int(logn + math.log(delta, 2)) + 1
        else:
            deltak = mink
        if K < deltak:
            continue

        M = ((1<<K) + delta) // DS
        maxV = maxNS * M
        bits = 0
        if maxV >= max128:
            print('%d\t%d\t%d\t%d\t%d\tinf\t: maxinum value (%d) exceeds uint128_t' % (D, maxN, S, M, K, maxV))
            return False
        elif maxV >= max64:
            bits = 128
            if not en128:
                print('%d\t%d\t%d\t%d\t%d\tu%d\t: maxinum value (%d) exceeds uint64_t' % (D, maxN, S, M, K, bits, maxV))
                return False
        elif maxV >= max32:
            bits = 64
        elif maxV >= max16:
            bits = 32
        else:
            bits = 16

        print('%d\t%d\t%d\t%d\t%d\tu%d' % (D, maxN, S, M, K, bits))
        return True
    return False

def get_fast_div(D, maxN):
    logd = math.log(D, 2)
    if logd == int(logd):
        print('%d\tany\t0\t1\t%d\tany' % (D, int(logd)))
        return True

    if fast_div(D, maxN, 0):
        return True

    S = 0
    while D % (2 ** (S + 1)) == 0:
        S += 1
    if not S:
        return False
    return fast_div(D, maxN, S)

def print_div_table():
    for i in range(1, 20):
        for j in range(i+1, 21):
            n = 10 ** j - 1
            d = 10 ** i
            if j == 10:
                get_fast_div(d, max32 - 1)
            if j == 20:
                get_fast_div(d, max64 - 1)
            get_fast_div(d, n)

print('D\tmaxN\tS\tM\tK\ttype')
if len(sys.argv) != 3:
    print_div_table()
else:
    get_fast_div(int(sys.argv[1]), int(sys.argv[2]))
print('#define FAST_DIV(N) ((((type)(N) >> S) * M) >> K)')
```

运行 `python3 fastdiv.py` 或 `python3 fastdiv.py <D> <maxN>`

## 常用快速除法表

| D                   | maxN                 | S   | M                    | K   | type |
| ------------------- | -------------------- | --- | -------------------- | --- | ---- |
| 3                   | 4294967295           | 0   | 2863311531           | 33  | u64  |
| 5                   | 4294967295           | 0   | 3435973837           | 34  | u64  |
| 7                   | 4294967295           | 0   | 4908534053           | 35  | u128 |
| 9                   | 4294967295           | 0   | 954437177            | 33  | u64  |
| 11                  | 4294967295           | 0   | 3123612579           | 35  | u64  |
| 13                  | 4294967295           | 0   | 1321528399           | 34  | u64  |
| 15                  | 4294967295           | 0   | 2290649225           | 35  | u64  |
| 17                  | 4294967295           | 0   | 4042322161           | 36  | u64  |
| 19                  | 4294967295           | 0   | 7233629131           | 37  | u128 |
| 21                  | 4294967295           | 0   | 6544712071           | 37  | u128 |
| 23                  | 4294967295           | 0   | 2987803337           | 36  | u64  |
| 31                  | 4294967295           | 0   | 4433514629           | 37  | u128 |

| D                   | maxN                 | S   | M                    | K   | type |
| ------------------- | -------------------- | --- | -------------------- | --- | ---- |
| 10                  | 4294967295           | 0   | 3435973837           | 35  | u64  |
| 100                 | 4294967295           | 0   | 1374389535           | 37  | u64  |
| 1000                | 4294967295           | 0   | 274877907            | 38  | u64  |
| 10000               | 4294967295           | 0   | 3518437209           | 45  | u64  |
| 100000              | 4294967295           | 5   | 175921861            | 39  | u64  |
| 1000000             | 4294967295           | 0   | 1125899907           | 50  | u64  |
| 10000000            | 4294967295           | 0   | 1801439851           | 54  | u64  |
| 100000000           | 4294967295           | 0   | 1441151881           | 57  | u64  |
| 1000000000          | 4294967295           | 9   | 281475               | 39  | u64  |
| 1000000000          | 18446744073709551615 | 9   | 19342813113834067    | 75  | u128 |
| 10000000000         | 18446744073709551615 | 0   | 15845632502852867519 | 97  | u128 |
| 100000000000        | 18446744073709551615 | 0   | 12676506002282294015 | 100 | u128 |
| 1000000000000       | 18446744073709551615 | 0   | 2535301200456458803  | 101 | u128 |
| 10000000000000      | 18446744073709551615 | 13  | 1980704062856609     | 81  | u128 |
| 100000000000000     | 18446744073709551615 | 0   | 811296384146066817   | 106 | u128 |
| 1000000000000000    | 18446744073709551615 | 15  | 633825300114115      | 84  | u128 |
| 10000000000000000   | 18446744073709551615 | 0   | 4153837486827862103  | 115 | u128 |
| 100000000000000000  | 18446744073709551615 | 17  | 101412048018259      | 86  | u128 |
| 1000000000000000000 | 18446744073709551615 | 18  | 81129638414607       | 88  | u128 |

| D                   | maxN                 | S   | M                    | K   | type |
| ------------------- | -------------------- | --- | -------------------- | --- | ---- |
| 100                 | 9999                 | 0   | 5243                 | 19  | u32  |
| 1000                | 999999               | 0   | 536871               | 29  | u64  |
| 10000               | 99999999             | 0   | 109951163            | 40  | u64  |
| 100000              | 9999999999           | 5   | 175921861            | 39  | u64  |
| 1000000             | 999999999999         | 0   | 1152921504607        | 60  | u128 |
| 10000000            | 99999999999999       | 0   | 59029581035871       | 69  | u128 |
| 100000000           | 9999999999999999     | 0   | 3022314549036573     | 78  | u128 |
| 1000000000          | 999999999999999999   | 0   | 309485009821345069   | 88  | u128 |
| 10000000000         | 18446744073709551615 | 0   | 15845632502852867519 | 97  | u128 |

| D                   | maxN                 | S   | M                    | K   | type |
| ------------------- | -------------------- | --- | -------------------- | --- | ---- |
| 10                  | 99                   | 0   | 103                  | 10  | u16  |
| 10                  | 999                  | 0   | 205                  | 11  | u32  |
| 10                  | 9999                 | 0   | 3277                 | 15  | u32  |
| 10                  | 99999                | 0   | 52429                | 19  | u64  |
| 10                  | 999999               | 0   | 838861               | 23  | u64  |
| 10                  | 9999999              | 0   | 6710887              | 26  | u64  |
| 10                  | 99999999             | 0   | 107374183            | 30  | u64  |
| 10                  | 999999999            | 0   | 214748365            | 31  | u64  |
| 10                  | 4294967295           | 0   | 3435973837           | 35  | u64  |
| 10                  | 9999999999           | 1   | 3435973837           | 34  | u64 |
| 10                  | 99999999999          | 0   | 54975581389          | 39  | u128 |
| 10                  | 999999999999         | 0   | 879609302221         | 43  | u128 |
| 10                  | 9999999999999        | 0   | 7036874417767        | 46  | u128 |
| 10                  | 99999999999999       | 0   | 112589990684263      | 50  | u128 |
| 10                  | 999999999999999      | 0   | 225179981368525      | 51  | u128 |
| 10                  | 9999999999999999     | 0   | 3602879701896397     | 55  | u128 |
| 10                  | 99999999999999999    | 0   | 57646075230342349    | 59  | u128 |
| 10                  | 999999999999999999   | 0   | 922337203685477581   | 63  | u128 |
| 10                  | 9999999999999999999  | 0   | 7378697629483820647  | 66  | u128 |
| 10                  | 18446744073709551615 | 0   | 14757395258967641293 | 67  | u64 |

| D                   | maxN                 | S   | M                    | K   | type |
| ------------------- | -------------------- | --- | -------------------- | --- | ---- |
| 10                  | 99                   | 0   | 103                  | 10  | u16  |
| 100                 | 999                  | 0   | 41                   | 12  | u16  |
| 1000                | 9999                 | 0   | 8389                 | 23  | u32  |
| 10000               | 99999                | 0   | 107375               | 30  | u64  |
| 100000              | 999999               | 0   | 687195               | 36  | u64  |
| 1000000             | 9999999              | 0   | 17592187             | 44  | u64  |
| 10000000            | 99999999             | 0   | 112589991            | 50  | u64  |
| 100000000           | 999999999            | 0   | 720575941            | 56  | u64  |
| 1000000000          | 9999999999           | 9   | 18014399             | 45  | u64  |
| 10000000000         | 99999999999          | 10  | 115292151            | 50  | u64  |
| 100000000000        | 999999999999         | 11  | 184467441            | 53  | u64  |
| 1000000000000       | 9999999999999        | 12  | 1180591621           | 58  | u64  |
| 10000000000000      | 99999999999999       | 0   | 123794003928539      | 90  | u128 |
| 100000000000000     | 999999999999999      | 0   | 198070406285661      | 94  | u128 |
| 1000000000000000    | 9999999999999999     | 0   | 2535301200456459     | 101 | u128 |
| 10000000000000000   | 99999999999999999    | 0   | 32451855365842673    | 108 | u128 |
| 100000000000000000  | 999999999999999999   | 0   | 830767497365572421   | 116 | u128 |
| 1000000000000000000 | 9999999999999999999  | 0   | 1329227995784915873  | 120 | u128 |

